<!DOCTYPE html>
<html lang="ru">
<head>
  <title>–†—É–ª–µ—Ç–∫–∞ –°—Ç–æ–ª</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { 
      background: #17212B; color: #FFF; font-family: Arial, sans-serif; text-align: center; padding: 10px; 
      margin: 0; height: 100vh; overflow-y: auto;
    }
    h1 { font-size: 24px; margin: 10px 0; }
    p { font-size: 14px; margin: 10px 0; }
    .table { 
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; max-width: 300px; margin: 20px auto; 
      padding: 10px; background: #000; border-radius: 10px;
    }
    .cell { 
      background: #333; border: 1px solid #666; padding: 15px; cursor: pointer; border-radius: 5px; 
      font-size: 18px; font-weight: bold; user-select: none; transition: background 0.2s;
    }
    .cell:hover { background: #FFA500 !important; color: #000; }
    .red { background: #FF0000; color: #FFF; }
    .black { background: #000000; color: #FFF; }
    .green { background: #00FF00; color: #000; grid-column: 1 / -1; padding: 20px; font-size: 24px; margin: 5px 0; }
    .history { 
      margin: 20px; font-size: 12px; overflow: auto; max-height: 80px; background: #222; padding: 10px; 
      border-radius: 5px; text-align: left;
    }
    .top3 { 
      margin: 20px; font-size: 16px; background: #222; padding: 15px; border-radius: 5px; min-height: 50px;
    }
    .analyze-input { 
      margin: 10px; padding: 10px; border: 1px solid #666; border-radius: 5px; background: #333; 
      color: #FFF; width: 150px; font-size: 16px;
    }
    button { 
      background: #FFA500; color: #000; border: none; padding: 12px 24px; margin: 5px; 
      border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s;
    }
    button:hover { background: #FF8C00; }
  </style>
</head>
<body>
  <h1>üé∞ –°—Ç–æ–ª –†—É–ª–µ—Ç–∫–∏ (–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∞—è)</h1>
  <p>–ö–ª–∏–∫–Ω–∏ —á–∏—Å–ª–æ –Ω–∞ —Å—Ç–æ–ª–µ ‚Äî –¥–æ–±–∞–≤—å –≤ –∏—Å—Ç–æ—Ä–∏—é (–æ–±–Ω–æ–≤–∏—Ç –±–∞–∑—É –±–æ—Ç–∞)</p>
  <div class="table" id="table"></div>
  <div style="margin: 20px;">
    <input type="number" id="analyzeInput" class="analyze-input" placeholder="–ß–∏—Å–ª–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (0-36 –∏–ª–∏ 00)" min="0" max="36">
    <button onclick="analyze()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
  <div class="history">
    –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10: <span id="histList"></span>
  </div>
  <div class="top3" id="top3">–¢–æ–ø-3: ...</div>
  <button onclick="clearHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

  <script>
    const WebApp = Telegram.WebApp;
    WebApp.ready();
    WebApp.expand();

    let history = [];
    const WORKER_URL = 'https://analiz-bot.zaugoldima.workers.dev';  // –¢–≤–æ–π Worker URL

    // –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞: –ø–æ—Ä—è–¥–æ–∫ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ (6 —Ä—è–¥–æ–≤ –ø–æ 3, —Ü–≤–µ—Ç–∞ red/black, 0/00 —Å–Ω–∏–∑—É –∑–µ–ª—ë–Ω—ã–µ)
    const numbers = [
      // –†—è–¥ 1: 1r 2b 3r
      {num: 1, color: 'red'}, {num: 2, color: 'black'}, {num: 3, color: 'red'},
      // –†—è–¥ 2: 4b 5r 6b
      {num: 4, color: 'black'}, {num: 5, color: 'red'}, {num: 6, color: 'black'},
      // –†—è–¥ 3: 7r 8b 9r
      {num: 7, color: 'red'}, {num: 8, color: 'black'}, {num: 9, color: 'red'},
      // –†—è–¥ 4: 10b 11b 12r
      {num: 10, color: 'black'}, {num: 11, color: 'black'}, {num: 12, color: 'red'},
      // –†—è–¥ 5: 13b 14r 15b
      {num: 13, color: 'black'}, {num: 14, color: 'red'}, {num: 15, color: 'black'},
      // –†—è–¥ 6: 16r 17b 18r
      {num: 16, color: 'red'}, {num: 17, color: 'black'}, {num: 18, color: 'red'},
      // –†—è–¥ 7: 19r 20b 21r
      {num: 19, color: 'red'}, {num: 20, color: 'black'}, {num: 21, color: 'red'},
      // –†—è–¥ 8: 22b 23r 24b
      {num: 22, color: 'black'}, {num: 23, color: 'red'}, {num: 24, color: 'black'},
      // –†—è–¥ 9: 25r 26b 27r
      {num: 25, color: 'red'}, {num: 26, color: 'black'}, {num: 27, color: 'red'},
      // –†—è–¥ 10: 28b 29r 30b
      {num: 28, color: 'black'}, {num: 29, color: 'red'}, {num: 30, color: 'black'},
      // –†—è–¥ 11: 31b 32r 33b
      {num: 31, color: 'black'}, {num: 32, color: 'red'}, {num: 33, color: 'black'},
      // –†—è–¥ 12: 34r 35b 36r
      {num: 34, color: 'red'}, {num: 35, color: 'black'}, {num: 36, color: 'red'}
    ];
    // –î–æ–±–∞–≤–ª—è–µ–º 0 –∏ 00 —Å–Ω–∏–∑—É (grid-column full)
    const zeroCell = {num: 0, color: 'green'};
    const doubleZeroCell = {num: 00, color: 'green'};

    const table = document.getElementById('table');

    // –°—Ç—Ä–æ–∏–º —Å–µ—Ç–∫—É: 1-36 –≤ 3-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–º grid (12 —Ä—è–¥–æ–≤? Wait, 36/3=12, –Ω–æ —Å–∫—Ä–∏–Ω 6? –û—à–∏–±–∫–∞ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ 12 —Ä—è–¥–æ–≤ –ø–æ 3? –ù–µ—Ç, —Ä—É–ª–µ—Ç–∫–∞ ‚Äî 3 –¥–ª–∏–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–∫–∏, –Ω–æ –≤ grid repeat(3,1fr) —Å 36 —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ = 12 —Ä—è–¥–æ–≤. –ß—Ç–æ–±—ã –∫–∞–∫ —Å–∫—Ä–∏–Ω (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ä—è–¥—ã), –æ—Å—Ç–∞–≤–ª—è–µ–º.
    numbers.forEach(item => {
      const cell = document.createElement('div');
      cell.className = `cell ${item.color}`;
      cell.textContent = item.num;
      cell.onclick = () => addNumber(item.num);
      table.appendChild(cell);
    });
    // 0 –∏ 00 —Å–Ω–∏–∑—É
    [zeroCell, doubleZeroCell].forEach(item => {
      const cell = document.createElement('div');
      cell.className = `cell ${item.color} green`;  // green class –¥–ª—è —à–∏—Ä–∏–Ω—ã
      cell.textContent = item.num;
      cell.onclick = () => addNumber(item.num);
      table.appendChild(cell);
    });

    function addNumber(num) {
      let normalized;
      if (num === 0 || num === 00) normalized = '00';
      else normalized = num.toString().padStart(2, '0');
      history.push(normalized);
      updateHistory();
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º (Worker)
      fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'add_number', number: normalized })
      }).then(r => r.json()).then(data => {
        if (data.success) WebApp.showAlert(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${num} (–±–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞)`);
      }).catch(e => WebApp.showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'));
    }

    function updateHistory() {
      document.getElementById('histList').textContent = history.slice(-10).join(' ');
    }

    async function analyze() {
      const input = document.getElementById('analyzeInput');
      let x = input.value.trim();
      let action = 'get_top_after_last';
      let bodyData = {};

      if (x) {
        if (x === '0' || x === '00') x = '00';
        else if (/^\d{1,2}$/.test(x) && 1 <= +x && +x <= 36) x = x.padStart(2, '0');
        else {
          WebApp.showAlert('–í–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–æ–µ —á–∏—Å–ª–æ: 0-36 –∏–ª–∏ 00');
          return;
        }
        action = 'get_top_after';
        bodyData = { number: x };
      }

      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, ...bodyData })
      });
      const data = await response.json();
      if (data.top && data.top.length > 0) {
        const topText = data.top.map(([n, c]) => `${n} (${c})`).join(', ');
        document.getElementById('top3').innerHTML = `–¢–æ–ø-3 –ø–æ—Å–ª–µ ${x || '–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ'}: ${topText} (–≤—Å–µ–≥–æ: ${data.total})`;
      } else {
        document.getElementById('top3').textContent = '–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–Ω—É–∂–Ω–æ 2+ —á–∏—Å–ª–∞).';
      }
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
      input.value = '';
    }

    async function clearHistory() {
      history = [];
      updateHistory();
      await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'clear_history' })
      });
      document.getElementById('top3').textContent = '–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.';
      WebApp.showAlert('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ Worker –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    fetch(WORKER_URL, { method: 'GET' }).then(r => r.json()).then(data => {
      history = data.history || [];
      updateHistory();
    }).catch(e => console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', e));
  </script>
</body>
</html>
