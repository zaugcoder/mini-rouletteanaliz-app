<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Рулетка Стол</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background: linear-gradient(to bottom, #0F172A, #1E293B); color: #FFF; font-family: system-ui; text-align: center; padding: 10px 0; margin: 0; height: 100vh; overflow-y: auto; }
    h1 { font-size: 28px; margin: 12px 0 6px; }
    .top3 { margin: 12px auto; font-size: 28px; font-weight: bold; background: #1E293B; padding: 12px 18px; border-radius: 28px; max-width: 350px; min-height: 56px; color: #F59E0B; }
    .table { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; max-width: 300px; margin: 12px auto; padding: 6px; }
    .cell { background: #333; border: none; padding: 0; cursor: pointer; border-radius: 50%; font-size: 14px; font-weight: 600; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .cell:hover { background: #F59E0B !important; color: #000; transform: scale(1.05); }
    .red { background: #EF4444; color: #FFF; }
    .black { background: #000; color: #FFF; }
    .green { background: #22C55E; color: #000; border-radius: 50px; aspect-ratio: 2/1; font-size: 18px; width: 90px; }
    .green-container { display: flex; justify-content: center; gap: 4px; grid-column: 1 / -1; }
  </style>
</head>
<body>
  <h1>Стол Рулетки</h1>
  <div class="top3" id="top3">Загрузка...</div>
  <div class="table" id="table"></div>
  <script>
    const WebApp = Telegram.WebApp;
    WebApp.ready();
    WebApp.expand();
    const WORKER_URL = 'https://analiz-bot.zaugoldima.workers.dev';
    const chatId = WebApp.initDataUnsafe?.user?.id;

    async function checkSub() {
      if (!chatId) { WebApp.showAlert('Ошибка ID'); WebApp.close(); return false; }
      try {
        const res = await fetch(`${WORKER_URL}?query=check-sub&chat_id=${chatId}`);
        const data = await res.json();
        if (!data.ok) { WebApp.showAlert('Подписка истекла\nКупи у @DimasZau'); WebApp.close(); return false; }
        return true;
      } catch { WebApp.showAlert('Нет связи'); WebApp.close(); return false; }
    }

    window.addEventListener('load', async () => {
      if (!await checkSub()) return;
      document.getElementById('top3').innerHTML = 'Готово';
      loadTable();
    });

    function loadTable() {
      const numbers = [
        {num:1,color:'red'},{num:2,color:'black'},{num:3,color:'red'},{num:4,color:'black'},{num:5,color:'red'},{num:6,color:'black'},
        {num:7,color:'red'},{num:8,color:'black'},{num:9,color:'red'},{num:10,color:'black'},{num:11,color:'black'},{num:12,color:'red'},
        {num:13,color:'black'},{num:14,color:'red'},{num:15,color:'black'},{num:16,color:'red'},{num:17,color:'black'},{num:18,color:'red'},
        {num:19,color:'red'},{num:20,color:'black'},{num:21,color:'red'},{num:22,color:'black'},{num:23,color:'red'},{num:24,color:'black'},
        {num:25,color:'red'},{num:26,color:'black'},{num:27,color:'red'},{num:28,color:'black'},{num:29,color:'black'},{num:30,color:'red'},
        {num:31,color:'black'},{num:32,color:'red'},{num:33,color:'black'},{num:34,color:'red'},{num:35,color:'black'},{num:36,color:'red'}
      ];
      const table = document.getElementById('table');
      const top3 = document.getElementById('top3');

      numbers.forEach(item => {
        const cell = document.createElement('div');
        cell.className = `cell ${item.color}`;
        cell.textContent = item.num;
        cell.onclick = () => analyze(item.num);
        table.appendChild(cell);
      });

      const green = document.createElement('div');
      green.className = 'green-container';
      [{num:0,color:'green'},{num:'00',color:'green'}].forEach(item => {
        const cell = document.createElement('div');
        cell.className = `cell ${item.color}`;
        cell.textContent = item.num === 0 ? '0' : '00';
        cell.onclick = () => analyze(item.num);
        green.appendChild(cell);
      });
      table.appendChild(green);

      async function analyze(num) {
        let x = (num === 0 || num === '00') ? '00' : num.toString().padStart(2, '0');
        top3.innerHTML = 'Расчёт: ...';
        const int = setInterval(() => {
          top3.innerHTML = `Расчёт: ${Array.from({length:3},()=>Math.floor(Math.random()*37).toString().padStart(2,'0')).join(' ')}`;
        }, 50);
        setTimeout(async () => {
          try {
            const res = await fetch(WORKER_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({action:'get_top_after',number:x}) });
            const data = await res.json();
            clearInterval(int);
            top3.innerHTML = data.top?.length ? `Ответ: ${data.top.map(([n])=>n.startsWith('0')?n.slice(1):n).join(' ')}` : 'Нет данных';
          } catch { clearInterval(int); top3.innerHTML = 'Ошибка'; }
        }, 1000);
      }
    }
  </script>
</body>
</html>
